name: Litmus Tests
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  integration-tests:
    name: Integration Tests
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
        ocaml-compiler:
          - 5.2.x
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up OCaml ${{ matrix.ocaml-compiler }}
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: ${{ matrix.ocaml-compiler }}
          dune-cache: true
          opam-depext: true
          opam-depext-flags: --with-test
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgmp-dev pkg-config
      
      - name: Install Z3
        run: |
          sudo apt-get install -y z3 libz3-dev
      
      - name: Pin package
        run: opam pin add . --no-action
      
      - name: Install dependencies
        run: |
          sudo apt-get install -y libev-dev
          opam update
          opam depext -y mordor
          opam install . --deps-only --with-test
          opam install menhir
          opam install logs fmt

      - name: Fix Landmarks stubs library
        run: |
          opam exec -- bash -c '
            LANDMARKS_DIR=$(opam var lib)/landmarks
            echo "Landmarks directory: $LANDMARKS_DIR"
            
            if [ -d "$LANDMARKS_DIR" ]; then
              cd "$LANDMARKS_DIR"
              ls -la
              
              if [ -f "liblandmark_stubs.a" ]; then
                ar x liblandmark_stubs.a 
                ocamlmklib -o landmark_stubs *.o 
                ls -lh liblandmark_stubs.a dlllandmark_stubs.so 
                cp dlllandmark_stubs.so $(ocamlc -where)/stublibs/ 
                rm *.o
                echo "Successfully fixed landmarks stubs library"
              else
                echo "Warning: liblandmark_stubs.a not found in $LANDMARKS_DIR"
              fi
            else
              echo "Warning: Landmarks directory not found at $LANDMARKS_DIR"
            fi
          '
      
      - name: Build project
        run: opam exec -- dune build
      
      - name: Run integration tests
        run: opam exec -- dune exec test/test_integration.exe
