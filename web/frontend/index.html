<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoRDor - Weak Memory Semantics</title>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/layout-base@2.0.1/layout-base.js"></script>
    <script src="https://unpkg.com/cose-base@2.2.0/cose-base.js"></script>
    <script src="https://unpkg.com/cytoscape-cose-bilkent@4.1.0/cytoscape-cose-bilkent.js"></script>
    <script src="https://unpkg.com/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1e1e1e; color: #d4d4d4; height: 100vh; overflow: hidden; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        header { background: #252526; border-bottom: 1px solid #3e3e42; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-size: 1.5rem; color: #cccccc; }
        .header-controls { display: flex; gap: 1rem; align-items: center; }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .panel { display: flex; flex-direction: column; background: #1e1e1e; border: 1px solid #3e3e42; position: relative; }
        .panel:first-child { flex: 0 0 50%; min-width: 200px; }
        .panel:last-child { flex: 1; min-width: 200px; }
        .resizer { width: 5px; background: #3e3e42; cursor: col-resize; flex-shrink: 0; position: relative; }
        .resizer:hover { background: #0e639c; }
        .resizer:active { background: #1177bb; }
        .panel-header { background: #252526; border-bottom: 1px solid #3e3e42; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { font-size: 1rem; color: #cccccc; }
        #litmus-input { flex: 1; padding: 1rem; background: #1e1e1e; border: none; color: #d4d4d4; font-family: 'Consolas', 'Courier New', monospace; font-size: 0.95rem; resize: none; outline: none; }
        
        /* Carousel styles */
        .carousel-container { flex: 1; position: relative; display: none; }
        .carousel-container.active { display: flex; flex-direction: column; }
        #cy { flex: 1; background: #1e1e1e; }
        
        .carousel-controls { position: absolute; top: 50%; left: 0; right: 0; display: flex; justify-content: space-between; align-items: center; pointer-events: none; z-index: 200; transform: translateY(-50%); padding: 0 10px; }
        .carousel-btn { pointer-events: all; background: rgba(37, 37, 38, 0.95); border: 1px solid #3e3e42; color: #cccccc; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.2s; }
        .carousel-btn:hover:not(:disabled) { background: #505050; transform: scale(1.1); }
        .carousel-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .carousel-indicator { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(37, 37, 38, 0.95); border: 1px solid #3e3e42; border-radius: 20px; padding: 0.5rem 1rem; font-size: 0.9rem; color: #cccccc; z-index: 100; }
        
        .graph-controls { position: absolute; top: 60px; right: 10px; background: rgba(37, 37, 38, 0.95); border: 1px solid #3e3e42; border-radius: 4px; padding: 0.5rem; display: none; flex-direction: column; gap: 0.5rem; z-index: 100; }
        .graph-controls.active { display: flex; }
        .graph-controls button { background: #3c3c3c; border: none; color: #cccccc; padding: 0.4rem 0.8rem; border-radius: 3px; cursor: pointer; font-size: 0.85rem; }
        .graph-controls button:hover { background: #505050; }
        .graph-controls select { background: #3c3c3c; border: 1px solid #555; color: #d4d4d4; padding: 0.4rem; border-radius: 3px; font-size: 0.85rem; }
        
        .graph-stats { position: absolute; bottom: 10px; left: 10px; background: rgba(37, 37, 38, 0.95); border: 1px solid #3e3e42; border-radius: 4px; padding: 0.5rem 0.75rem; font-size: 0.85rem; z-index: 100; display: none; }
        .graph-stats.active { display: block; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6a6a6a; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 0.5rem 1.5rem; font-size: 0.9rem; font-weight: 500; }
        .btn-primary { background: #0e639c; color: white; }
        .btn-primary:hover { background: #1177bb; }
        .btn-primary:disabled { background: #555; cursor: not-allowed; }
        .status { font-size: 0.85rem; color: #cccccc; }
        #log { background: #252526; border-top: 1px solid #3e3e42; height: 150px; overflow-y: auto; padding: 0.5rem 1rem; font-family: 'Consolas', monospace; font-size: 0.85rem; }
        .log-entry { padding: 0.25rem 0; }
        .error { color: #f48771; }
        .success { color: #89d185; }
        .info { color: #4ec9b0; }
        .spinner { border: 3px solid #3c3c3c; border-top: 3px solid #0e639c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ”® MoRDor - Weak Memory Semantics</h1>
            <div class="header-controls">
                <label>Steps: <input type="number" id="step-counter" value="5" min="1" max="100" style="width:70px; padding:0.3rem; background:#3c3c3c; border:1px solid #555; color:#d4d4d4; border-radius:4px;"></label>
                <button id="visualize-btn" class="btn-primary">Visualize</button>
            </div>
        </header>
        <div class="main-content">
            <div class="panel" id="left-panel">
                <div class="panel-header">
                    <h2>Litmus Source</h2>
                    <select id="examples" style="padding:0.3rem; background:#3c3c3c; border:1px solid #555; color:#d4d4d4; border-radius:4px;">
                        <option value="">-- Select Example --</option>
                        <option value="sb">Store Buffering (SB)</option>
                        <option value="mp">Message Passing (MP)</option>
                        <option value="lb">Load Buffering (LB)</option>
                    </select>
                </div>
                <textarea id="litmus-input" placeholder="Enter your litmus test here..."></textarea>
            </div>
            <div class="resizer" id="resizer"></div>
            <div class="panel" id="right-panel">
                <div class="panel-header">
                    <h2>Event Structure & Executions</h2>
                    <div class="status" id="status">Ready</div>
                </div>
                
                <div class="carousel-container" id="carousel-container">
                    <div id="cy"></div>
                    <div class="carousel-controls">
                        <button class="carousel-btn" id="prev-btn" disabled>â€¹</button>
                        <button class="carousel-btn" id="next-btn" disabled>â€º</button>
                    </div>
                    <div class="carousel-indicator" id="carousel-indicator">Event Structure</div>
                </div>
                
                <div id="empty-state" class="empty-state">
                    <p>Enter litmus source and click "Visualize"</p>
                </div>

                <div class="execution-info" id="execution-info">
                  <div><strong>Predicates:</strong> <span
                      id="predicates">âŠ¤</span></div>
                </div>
                
                <div class="graph-controls" id="graph-controls">
                    <select id="layout-select">
                        <option value="breadthfirst">Hierarchical</option>
                        <option value="fcose">fCoSE (Fast)</option>
                        <option value="cose-bilkent">COSE (Quality)</option>
                        <option value="circle">Circle</option>
                    </select>
                    <button id="fit-btn">Fit</button>
                    <button id="export-png-btn">Export PNG</button>
                </div>
                
                <div class="graph-stats" id="graph-stats">
                    <div><strong>Nodes:</strong> <span id="node-count">0</span></div>
                    <div><strong>Edges:</strong> <span id="edge-count">0</span></div>
                    <div><strong>Executions:</strong> <span id="execution-count">0</span></div>
                </div>
            </div>
        </div>
        <div id="log"></div>
    </div>
    <script>
const EXAMPLES = {
    sb: "name = SB\n%%\n{ x := 1 } ||| { y := 1 }\n%% allow (x = 0 && y = 0) [rc11]",
    mp: "name = MP\n%%\n{ x := 1; y := 1 } ||| { r1 := y; r2 := x }\n%% forbid (r1 = 1 && r2 = 0) [rc11]",
    lb: "name = LB\n%%\n{ r1 := x; y := 1 } ||| { r2 := y; x := 1 }\n%% forbid (r1 = 1 && r2 = 1) [rc11]"
};

// Edge color mapping - moved from backend
const EDGE_COLORS = { 
    po: '#4ec9b0',    // Teal
    rf: '#0e639c',    // Blue
    dp: '#ffa500',    // Orange
    ppo: '#9370db',   // Purple
    rmw: '#f48771',   // Red
    co: '#ffa500',    // Orange
    fr: '#f48771',    // Red
    lo: '#0e639c',    // Blue
    fj: '#89d185',    // Green
    default: '#6a6a6a' 
};

// Resizer functionality
const resizer = document.getElementById('resizer');
const leftPanel = document.getElementById('left-panel');
const rightPanel = document.getElementById('right-panel');

let isResizing = false;

resizer.addEventListener('mousedown', (e) => {
    isResizing = true;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    
    const containerRect = leftPanel.parentElement.getBoundingClientRect();
    const offsetLeft = e.clientX - containerRect.left;
    const containerWidth = containerRect.width;
    
    let percentage = (offsetLeft / containerWidth) * 100;
    percentage = Math.max(20, Math.min(80, percentage));
    
    leftPanel.style.flex = `0 0 ${percentage}%`;
});

document.addEventListener('mouseup', () => {
    if (isResizing) {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }
});

class GraphVisualizer {
    constructor() {
        this.graphs = [];  // Array to store all graphs
        this.currentIndex = 0;
        this.executionCount = 0;

        this.cy = cytoscape({
            container: document.getElementById('cy'),
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#0e639c',
                        'label': 'data(label)',
                        'color': '#ffffff',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': '11px',
                        'font-weight': 'bold',
                        'shape': 'roundrectangle',
                        'width': 'label',
                        'min-width': '30px',
                        'height': '20px',
                        'padding': '12px',
                        'text-wrap': 'wrap',
                        'text-max-width': '180px'
                    }
                },
                {
                    selector: 'node[isRoot]',
                    style: {
                        'background-color': '#1177bb',
                        'border-width': '3px',
                        'border-color': '#ffffff'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': 'data(color)',
                        'target-arrow-color': 'data(color)',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'arrow-scale': 1.2,
                        'label': 'data(type)',
                        'font-size': '9px',
                        'color': '#cccccc',
                        'text-background-color': '#1e1e1e',
                        'text-background-opacity': 0.8,
                        'text-background-padding': '2px'
                    }
                }
            ],
            layout: { name: 'preset' },
            minZoom: 0.1,
            maxZoom: 3,
            wheelSensitivity: 0.2
        });

        this.setupEventListeners();
    }

    setupEventListeners() {
        document.getElementById('examples').addEventListener('change', (e) => {
            const example = EXAMPLES[e.target.value];
            if (example) {
                document.getElementById('litmus-input').value = example;
                this.log('Example loaded: ' + e.target.options[e.target.selectedIndex].text);
            }
        });

        document.getElementById('visualize-btn').addEventListener('click', () => {
            const program = document.getElementById('litmus-input').value.trim();
            if (!program) {
                this.log('Please enter a litmus test', 'error');
                return;
            }
            this.visualize(program);
        });

        document.getElementById('layout-select').addEventListener('change', (e) => {
            this.applyLayout(e.target.value);
        });

        document.getElementById('fit-btn').addEventListener('click', () => {
            this.cy.fit(null, 50);
            this.log('View reset to fit');
        });

        document.getElementById('export-png-btn').addEventListener('click', () => {
            const png = this.cy.png({ full: true, scale: 2 });
            const link = document.createElement('a');
            link.download = `graph-${this.currentIndex}.png`;
            link.href = png;
            link.click();
            this.log('Graph exported as PNG');
        });

        // Carousel controls
        document.getElementById('prev-btn').addEventListener('click', () => {
            this.navigateTo(this.currentIndex - 1);
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            this.navigateTo(this.currentIndex + 1);
        });
    }

    navigateTo(index) {
        if (index < 0 || index >= this.graphs.length) return;
        
        this.currentIndex = index;
        this.renderGraph(this.graphs[index]);
        this.updateCarouselUI();
    }

    updateCarouselUI() {
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const indicator = document.getElementById('carousel-indicator');

        prevBtn.disabled = this.currentIndex === 0;
        nextBtn.disabled = this.currentIndex === this.graphs.length - 1;

        if (this.currentIndex === 0) {
            indicator.textContent = 'Event Structure';
        } else {
            indicator.textContent = `Execution ${this.currentIndex}/${this.executionCount}`;
        }
    }

    visualize(program) {
        const steps = parseInt(document.getElementById('step-counter').value) || 5;
        this.log('Starting visualization with ' + steps + ' steps...');
        
        // Reset state
        this.graphs = [];
        this.currentIndex = 0;
        this.executionCount = 0;
        
        document.getElementById('visualize-btn').disabled = true;
        document.getElementById('status').textContent = 'Processing...';

        const params = new URLSearchParams({
            program: program,
            steps: steps.toString()
        });

        const es = new EventSource('/api/visualize/stream?' + params);
        
        es.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                if (data.status === 'parsing') {
                    this.log('Parsing litmus test...');
                } else if (data.status === 'interpreting') {
                    this.log('Interpreting program...');
                } else if (data.status === 'visualizing') {
                    this.log('Generating visualizations...');
                } else if (data.type === 'event_structure') {
                    this.log('Received event structure');
                    this.graphs.push(data.graph);
                    if (this.graphs.length === 1) {
                        this.renderGraph(data.graph);
                        this.updateCarouselUI();
                    }
                } else if (data.type === 'execution') {
                    this.log('Received execution ' + data.index);
                    this.graphs.push(data.graph);
                } else if (data.type === 'complete') {
                    this.executionCount = data.total_executions;
                    document.getElementById('execution-count').textContent = this.executionCount;
                    this.log('Visualization complete: ' + this.executionCount + ' executions', 'success');
                    this.updateCarouselUI();
                    document.getElementById('status').textContent = 'Complete';
                    es.close();
                    document.getElementById('visualize-btn').disabled = false;
                } else if (data.error) {
                    this.log('Error: ' + data.error, 'error');
                    this.showError(data.error);
                    es.close();
                    document.getElementById('visualize-btn').disabled = false;
                }
            } catch (e) {
                console.error('Failed to parse SSE message:', e);
                this.log('Parse error: ' + e.message, 'error');
            }
        };

        es.onerror = () => { 
            this.log('Connection error', 'error'); 
            es.close(); 
            document.getElementById('visualize-btn').disabled = false; 
        };
    }

    renderGraph(data) {
        try {
            const graph = data;
            
            this.log('Rendering graph with ' + graph.nodes.length + ' nodes...');

            if (!graph.nodes || graph.nodes.length === 0) {
                this.log('No nodes in graph data', 'error');
                return;
            }

            this.cy.elements().remove();

            // Add nodes
            graph.nodes.forEach(n => {
                let label = '';

                if (n.type && n.location && n.value) {
                    label = n.label + ":" + n.type + ' ' + n.location + ' ' +
                    n.value;
                } else if (n.type && n.location) {
                    label = n.label + ":" + n.type + ' ' + n.location;
                } else if (n.type && n.value) {
                    label = n.label + ":" + n.type + ' ' + n.value;
                } else if (n.type) {
                    label = n.type;
                } else if (n.label !== undefined && n.label !== null) {
                    label = String(n.label);
                } else {
                    label = String(n.id);
                }

                this.cy.add({
                    data: {
                        id: String(n.id),
                        label: label,
                        isRoot: n.isRoot
                    }
                });
            });

            // Add edges with color mapping from frontend
            graph.edges.forEach(e => {
                // Extract base edge type (before any " - " predicates)
                const baseType = e.type.split(' - ')[0];
                const color = EDGE_COLORS[baseType] || EDGE_COLORS.default;

                this.cy.add({
                    data: {
                        source: String(e.source),
                        target: String(e.target),
                        color: color,
                        type: e.type
                    }
                });
            });

            this.applyLayout('breadthfirst');

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('carousel-container').classList.add('active');
            document.getElementById('graph-controls').classList.add('active');
            document.getElementById('graph-stats').classList.add('active');
            document.getElementById('node-count').textContent = graph.nodes.length;
            document.getElementById('edge-count').textContent = graph.edges.length;

        } catch (error) {
            this.log('Render failed: ' + error.message, 'error');
            console.error('Render error:', error);
            this.showError('Failed to render graph: ' + error.message);
        }
    }

    showError(message) {
        document.getElementById('empty-state').innerHTML = '<div style="color: #f48771; padding: 2rem; text-align: center;"><p>' + message + '</p><p style="margin-top: 1rem; font-size: 0.9rem;">Check browser console for details (F12)</p></div>';
        document.getElementById('empty-state').style.display = 'flex';
    }

    applyLayout(name) {
        const configs = {
            fcose: { name: 'fcose', animate: true, fit: true, padding: 50, nodeSeparation: 150 },
            'cose-bilkent': { name: 'cose-bilkent', animate: true, fit: true, padding: 50 },
            breadthfirst: { 
                name: 'breadthfirst', 
                directed: true, 
                animate: true, 
                fit: true, 
                padding: 50,
                spacingFactor: 1.5,
                // Only use "po" edges for determining hierarchy
                roots: this.cy.nodes().roots(),
                edgeFilter: (edge) => {
                    const type = edge.data('type');
                    const baseType = type ? type.split(' - ')[0] : '';
                    return baseType === 'po';
                }
            },
            circle: { name: 'circle', animate: true }
        };
        const layout = this.cy.layout(configs[name] || configs.breadthfirst);
        layout.run();
        
        // Automatically fit the graph after layout completes
        layout.one('layoutstop', () => {
            this.cy.fit(null, 50);
        });
    }

    log(msg, type = 'info') {
        const time = new Date().toLocaleTimeString();
        const cls = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
        document.getElementById('log').innerHTML += '<div class="log-entry ' + cls + '">[' + time + '] ' + msg + '</div>';
        document.getElementById('log').scrollTop = 999999;
    }
}

new GraphVisualizer();
    </script>
</body>
</html>
